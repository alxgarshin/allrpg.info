withDocumentEvents&&(_(document).on("click",".new_project_conversation, .new_community_conversation",(function(e){e.stopImmediatePropagation();let self=_(this);const form=self.parent().find("div.conversation_form").first();self.hide(),self.next("div.tabs_horizontal_shadow")?.first()?.hide(),form.hasClass("shown")||form.addClass("shown"),self=form.find('input[name="name"]').first(),self.asDomElement()?(self.focus(),self.val("")):(self=form.find('textarea[name="content"]').first(),self.focus(),self.val(""))})),_(document).on("click","a.attach",(function(){const target=_(this).closest("div.conversation_form_data").find("div.conversation_form_attachments");target.toggleClass("shown"),target.hasClass("shown")&&filepondObjs.get(target.find("input[type=file]").attr("name")).browse()})),_(document).on("click","a.vote",(function(){_(this).closest("div.conversation_form_data").find("div.conversation_form_vote").show()})),_(document).on("focusin",'div.conversation_form_data textarea, div.conversation_form_data input[type="text"]:not(.dpkr_time)',(function(){showConversationForm(_(this))})),_(document).on("keyup","div.conversation_form_data textarea, textarea#dialog_new_message",(function(){const self=_(this);fraymAutocompleteApply(self,{source:"/helper_users_list/?no_id=1",conditionalSearch:!0,select:function(){const text=self.val(),prependingText=text.substring(0,this.closestIndice+1),followingText=text.substring(this.currentPosition,text.length);self.val(prependingText+this.value+"["+this.sid+"]"+followingText)}})})),_(document).on("click",'div.conversation_form_data input[name="vote_answer_add"]',(function(){const self=_(this),prev=self.prev("input"),tabbi=+prev.attr("tabIndex")+1,name=+prev.attr("name").match(/\d+/)+1,newVoteAnswer=elFromHTML(`<input name="vote_answer[${name}]" type="text" placehold="${LOCALE.voteChoice}" tabIndex="${tabbi}">`);self.insert(newVoteAnswer,"before").insert("<br>","before"),fraymPlaceholder(newVoteAnswer),_(newVoteAnswer).focus()})),_(document).on("click",(function(e){_(e.target).is("div.conversation_form_data, div.conversation_form_data *, a.wall_message_reply, button.new_project_conversation, button.new_project_conversation *, button.new_community_conversation, button.new_community_conversation *, a.conversation_message_reply, div.task_status, div.task_priority")||_("div.conversation_form:not(.do_not_hide)").each((function(){const self=_(this);""!==self.find("textarea").val()&&self.find("textarea").val()!==self.find("textarea").attr("placehold")||(self.find("div#help_conversation_form_data").hide(),self.removeClass("opened"))}))})),_(document).on("focusin",'div.conversation_form_data textarea[name="content"]',(function(){const helpDiv=_(this).closest("div.conversation_form").find("div#help_conversation_form_data").first().asDomElement();helpDiv&&showHelpAndName(helpDiv,this)})),_(document).on("focusout",'div.conversation_form_data textarea[name="content"]',(function(){const helpDiv=_(this).closest("div.conversation_form").find("div#help_conversation_form_data").first().asDomElement();helpDiv&&_(helpDiv).hide()})),_(document).on("change",'div.wall_message_vote_choice > input[type="radio"], div.conversation_message_vote_choice > input[type="radio"]',(function(){const self=_(this);actionRequest({action:"message/vote",m_id:self.attr("m_id"),value:self.attr("value"),type:self.closest(".wall_message_vote_choice")?"wall":"conversation"},self)})),_arSuccess("add_comment",(function(jsonData,params,target){const content=target.find('[name="content"]').val();target.find('[name="content"]').val(""),target.find('[name="name"]')?.val(""),target.find('[name="vote_name"]')?.val(""),target.find('[name^="vote_answer["]')?.val(""),target.find('[name^="vote_answer["]:not([name="vote_answer[0]"])')?.next("br")?.remove(),target.find('[name^="vote_answer["]:not([name = "vote_answer[0]"])')?.remove(),target.find("div.uploaded_file")?.remove(),target.find("div.conversation_form_attachments")?.hide(),target.find("div.conversation_form_vote")?.hide();if(target.find("button.main").each((function(){_(this).enable(),removeLoader(this)})),jsonData.html&&"reload"!=jsonData.html){const comment_type=target.find('[name="obj_type"]').val();let appendToBlock=null,result=elFromHTML(jsonData.html);if("{task_comment}"==comment_type||"{event_comment}"==comment_type)appendToBlock=_('[class$="_comment_form"]').closest("div.block"),appendToBlock.insert(result,"begin");else if("{calendar_event_notion}"==comment_type){const rating=target.find('[name="rating"]')?.val(),header=target.closest("div.block_data")?.prev("h2").find("sup"),curRating=header.text();if(appendToBlock=target.closest("div.block_data"),appendToBlock.insert(result,"begin"),curRating){let newRating=parseInt(curRating)+parseInt(rating);newRating=newRating.toString(),newRating>0&&(newRating=`+${newRating}`),header.text(newRating)}target.closest("div.block_data").find(".conversation_form").remove()}else if("{project_wall}"==comment_type||"{community_wall}"==comment_type||"{publication_wall}"==comment_type||"{ruling_item_wall}"==comment_type){target.find('[name="parent"]').val()>0?(appendToBlock=target.closest("div.conversation_form"),appendToBlock.insert(result,"before")):(appendToBlock=target.closest("div.block_header").next("div.block_data"),appendToBlock.insert(result,"before"))}else if("{project_conversation}"==comment_type||"{community_conversation}"==comment_type||"{project_application_conversation}"==comment_type){const parent=target.find('[name="parent"]')?.val();if(parent>0){const parentDiv=target.closest("div.conversation_message_container")?.find(`div.conversation_message[message_id="${parent}"]`),level=parseInt(parentDiv?.attr("level"));parentDiv?.next("div.conversation_message_children_container")?appendToBlock=parentDiv.next("div.conversation_message_children_container"):(appendToBlock=elFromHTML('<div class="conversation_message_children_container"></div>'),parentDiv?.insert(appendToBlock,"after"),appendToBlock=_(appendToBlock)),_(result).attr("level",level+(level<5?1:0)),appendToBlock.insert(result,"end")}else appendToBlock=target.closest("div.conversation_form"),appendToBlock.insert(result,"after");"{project_application_conversation}"==comment_type&&_('input[name="updated_at[0]"]').val(parseInt(jsonData.response_updated_at)+20)}else if("{conversation_message}"==comment_type){if(target.closest("div.qrpg_description"))showMessageFromJsonData(jsonData);else{const conversationBlock=_(`div.message[c_id="${jsonData.c_id}"]`),dt=new Date;appendToBlock=_("a#bottom"),appendToBlock.insert(result,"before"),appendToBlock.parent().scrollTop(appendToBlock.parent().asDomElement()?.scrollHeight),_("div.conversation_message_switcher_scroller").insert(conversationBlock.asDomElement(),"begin"),conversationBlock.find("div.content_preview")?.addClass("unread").removeClass("counter").html(`<span class="gray">${LOCALE.you}:</span> ${content.nl2space().substring(0,40)}`),conversationBlock.find("div.time").html(("0"+dt.getHours()).slice(-2)+":"+("0"+dt.getMinutes()).slice(-2))}}result&&(result=_(result),result.find("input.inputfile[type=file]")?.each((function(){fraymFileUploadApply(this,fileuploadOptions)})),result.find('input[type="text"], input[type="password"], textarea')?.each((function(){const field=_(this);field.is("[placehold]")&&fraymPlaceholder(field)}))),_("body").click()}if(el('button[id$="_library_link_wrapper"]')){const loadLibraryBtn=_('button[id$="_library_link_wrapper"]'),loadLibraryLink=elFromHTML("<a></a>");loadLibraryBtn.parent().insert(loadLibraryLink,"append"),actionRequest({action:"file/load_library",obj_type:loadLibraryBtn.attr("obj_type"),obj_id:loadLibraryBtn.attr("obj_id"),external:"false"},_(loadLibraryLink))}else"reload"==jsonData.html?updateState(currentHref):showMessagesFromJson(jsonData)})),_arError("add_comment",(function(jsonData,params,target,error){target.find("button.main").each((function(){_(this).enable(),removeLoader(this)}))})),_arSuccess("vote",(function(jsonData,params,target){jsonData.response_text.length&&(target.closest(`div.${params.type}_message_content`)?.find(`div.${params.type}_message_vote_choice`)?.hide(),target.closest(`div.${params.type}_message_content`)?.insert(jsonData.response_text,"append"))})));